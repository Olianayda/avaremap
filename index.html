<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAKSA Technology Validation Map</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Specific override for map tiles to look clean/greyscale */
        .leaflet-tile { filter: grayscale(100%) brightness(1.05); }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo">MAKSA Technology Validation Map</a>
    <a href="search.html" style="margin-left: auto; margin-right: 20px; color: var(--primary); text-decoration: none; font-weight: 600;">Directory</a>
    <a href="https://avareit.com/" class="cta-btn">Try Semen Analysis with MAKSA</a>
</header>

<div id="map-container"></div>

<div class="developer-tag">
    Developed by <a href="https://avareit.com" target="_blank">avareit.com</a>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="data.js"></script>
<script>
    // Initialize Map
    const map = L.map('map-container', {
        center: [20, 0],
        zoom: 2,
        minZoom: 2,
        zoomControl: false,
        attributionControl: false
    });

    // Light/Clean Tiles
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // Fetch World GeoJSON (Countries)
    fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
        .then(res => res.json())
        .then(geoJson => {
            
            L.geoJson(geoJson, {
                style: {
                    fillColor: '#334155',
                    weight: 1,
                    opacity: 1,
                    color: 'white',
                    fillOpacity: 0.1
                },
                onEachFeature: (feature, layer) => {
                    const countryName = feature.properties.name;
                    
                    // Filter companies for this country
                    const countryCompanies = companies.filter(c => c.country === countryName);
                    
                    // Interaction logic
                    layer.on({
                        mouseover: (e) => {
                            const layer = e.target;
                            layer.setStyle({ fillOpacity: 0.3, fillColor: '#2563eb' });

                            if (countryCompanies.length > 0) {
                                let listHtml = `<div class="country-tooltip"><h4>${countryName}</h4><ul class="tooltip-list">`;
                                countryCompanies.forEach(comp => {
                                    listHtml += `
                                        <li class="tooltip-item" onclick="window.location.href='company.html?id=${comp.id}'">
                                            <img src="${comp.image}" alt="${comp.name}">
                                            <div class="tooltip-info">
                                                <b>${comp.name}</b>
                                                <span>${comp.shortTitle}</span>
                                            </div>
                                        </li>
                                    `;
                                });
                                listHtml += `</ul></div>`;
                                
                                layer.bindPopup(listHtml, { closeButton: false, offset: [0, -10] }).openPopup();
                            }
                        },
                        mouseout: (e) => {
                            geoJsonLayer.resetStyle(e.target);
                        },
                        click: (e) => {
                            // If companies exist, zoom to country, otherwise do nothing
                            if (countryCompanies.length > 0) {
                                map.fitBounds(e.target.getBounds());
                            }
                        }
                    });
                }
            }).addTo(map);
            
            // Assign to variable for resetStyle access
            const geoJsonLayer = arguments[0];
        });
</script>

</body>
</html>