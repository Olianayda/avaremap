<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAKSA Technology Validation Map</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .leaflet-tile { filter: grayscale(100%) brightness(1.05); }
        /* Style for the 'Become First' button */
        .whatsapp-btn {
            display: block; margin-top: 10px; padding: 8px 12px;
            background: #25D366; color: white; text-decoration: none;
            border-radius: 6px; font-weight: bold; text-align: center;
        }
        .whatsapp-btn:hover { background: #128C7E; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo">MAKSA Technology Validation Map</a>
    <a href="search.html" class="cta-btn" style="background: #334155; margin-left: auto; margin-right: 15px;">All Companies</a>
    <a href="https://avareit.com/" class="cta-btn">Try Semen Analysis with MAKSA</a>
</header>

<div id="map-container"></div>

<div class="developer-tag">
    Developed by <a href="https://avareit.com" target="_blank">avareit.com</a>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="data.js"></script>
<script>
    const map = L.map('map-container', {
        center: [35, -40], zoom: 3, minZoom: 2, zoomControl: false, attributionControl: false
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd', maxZoom: 19
    }).addTo(map);

    // 1. Add Black Dots for all companies (Use a pane to ensure they are on top)
    map.createPane('dots');
    map.getPane('dots').style.zIndex = 650;

    companies.forEach(c => {
        L.circleMarker([c.lat, c.lng], {
            pane: 'dots',
            color: '#000000',      // Black border
            fillColor: '#000000',  // Black fill
            fillOpacity: 1,
            radius: 4,             // Small dot size
            weight: 1
        }).addTo(map);
    });

    // 2. Fetch Countries and Apply Logic
    let geoJsonLayer; // Defined outside so it can be used in mouseout

    fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
        .then(res => res.json())
        .then(geoJson => {
            
            geoJsonLayer = L.geoJson(geoJson, {
                style: (feature) => {
                    const countryName = feature.properties.name;
                    const hasCompany = companies.some(c => c.country === countryName);
                    return {
                        fillColor: hasCompany ? '#FFD700' : '#334155', 
                        weight: 1,
                        opacity: 1,
                        color: 'white',
                        fillOpacity: hasCompany ? 0.5 : 0.1 
                    };
                },
                onEachFeature: (feature, layer) => {
                    const countryName = feature.properties.name;
                    const countryCompanies = companies.filter(c => c.country === countryName);
                    
                    // Logic for "Empty" Countries
                    if (countryCompanies.length === 0) {
                        const waLink = "https://api.whatsapp.com/send/?phone=971506412775&text=Hello.+I%27m+interested+in+subscribing+to+the+software&type=phone_number&app_absent=0";
                        
                        layer.bindPopup(`
                            <div style="text-align:center; padding:10px;">
                                <b>${countryName}</b> has no partners yet.
                                <a href="${waLink}" class="whatsapp-btn" target="_blank">Become first from ${countryName}</a>
                            </div>
                        `);
                    } 
                    // Logic for "Active" Countries (Gold)
                    else {
                        let listHtml = `<div class="country-tooltip"><h4>${countryName}</h4><ul class="tooltip-list">`;
                        countryCompanies.forEach(comp => {
                            listHtml += `
                                <li class="tooltip-item" onclick="window.location.href='company.html?id=${comp.id}'">
                                    <img src="${comp.image}" alt="${comp.name}">
                                    <div class="tooltip-info"><b>${comp.name}</b><span>${comp.shortTitle}</span></div>
                                </li>`;
                        });
                        listHtml += `</ul></div>`;
                        layer.bindPopup(listHtml, { closeButton: false, offset: [0, -10] });
                    } // <--- THIS CLOSING BRACE WAS MISSING

                    // Hover Effects
                    layer.on({
                        mouseover: (e) => {
                            const layer = e.target;
                            if (countryCompanies.length > 0) {
                                layer.setStyle({ fillColor: '#B8860B', fillOpacity: 0.7 }); // Dark Gold
                                layer.openPopup();
                            } else {
                                layer.setStyle({ fillOpacity: 0.2 });
                            }
                        },
                        mouseout: (e) => {
                            geoJsonLayer.resetStyle(e.target);
                            if (countryCompanies.length > 0) {
                                layer.closePopup();
                            }
                        },
                        click: (e) => {
                            if (countryCompanies.length === 0) {
                                layer.openPopup(); 
                            } else {
                                map.fitBounds(e.target.getBounds());
                            }
                        }
                    });
                }
            }).addTo(map);
        });
</script>

</body>
</html>
